name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build & Validate
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4

      - name: Print build environment
        run: |
          xcodebuild -version
          swift --version

      # Build release binary via Swift Package Manager
      - name: Build with SPM (Release)
        run: cd Speak && swift build -c release

      # Validate the compiled binary
      - name: Validate binary
        run: |
          EXEC=$(find Speak/.build/release -name "Speak" -type f | head -1)
          test -n "$EXEC" || { echo "FAIL: Speak binary not found in build output"; exit 1; }
          echo "── Binary: $EXEC"
          file "$EXEC"

          echo "── Checking linked frameworks"
          FRAMEWORKS=$(otool -L "$EXEC" | tail -n +2)
          echo "$FRAMEWORKS"
          for fw in Speech AVFoundation AppKit CoreGraphics; do
            echo "$FRAMEWORKS" | grep -q "$fw" || { echo "FAIL: $fw not linked"; exit 1; }
          done

          echo "── All checks passed"

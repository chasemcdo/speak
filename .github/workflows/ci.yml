name: CI

on:
  push:
    branches: [main]
    paths:
      - 'Speak/**'
      - 'Package.swift'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'Speak/**'
      - 'Package.swift'
      - '.github/workflows/ci.yml'

jobs:
  build:
    name: Build & Validate
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4

      - name: Print build environment
        run: |
          xcodebuild -version
          swift --version

      # Formatting & linting (run before build to catch issues early)
      - name: Install SwiftFormat & SwiftLint
        run: brew install swiftformat swiftlint

      - name: Check formatting
        run: swiftformat --lint Speak/

      - name: Lint
        run: swiftlint lint Speak/Speak/ Speak/Tests/

      # Run unit tests
      - name: Run tests
        run: cd Speak && swift test

      # Build release binary via Swift Package Manager
      - name: Build with SPM (Release)
        run: cd Speak && swift build -c release

      # Validate the compiled binary
      - name: Validate binary
        run: |
          BIN_PATH=$(cd Speak && swift build -c release --show-bin-path)
          echo "── SPM bin path: $BIN_PATH"

          EXEC="$BIN_PATH/Speak"
          if [ ! -f "$EXEC" ]; then
            echo "── Speak not at expected path, searching..."
            echo "── Contents of $BIN_PATH:"
            ls -la "$BIN_PATH" || true
            echo "── All files named Speak under .build:"
            find Speak/.build -name "Speak" 2>/dev/null || true
            EXEC=$(find Speak/.build -name "Speak" -type f | head -1)
          fi

          test -f "$EXEC" || { echo "FAIL: Speak binary not found"; exit 1; }
          echo "── Binary: $EXEC"
          file "$EXEC"

          echo "── Checking linked frameworks"
          FRAMEWORKS=$(otool -L "$EXEC" | tail -n +2)
          echo "$FRAMEWORKS"
          for fw in Speech AVFoundation AppKit CoreGraphics; do
            echo "$FRAMEWORKS" | grep -q "$fw" || { echo "FAIL: $fw not linked"; exit 1; }
          done

          echo "── All checks passed"
